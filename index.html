<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading System â€” RR/HR + Checklist</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --muted:#9aa7c7; --text:#eef2ff; --good:#41d38b; --bad:#ff5c7a; --warn:#ffcc66; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Tahoma,Arial; background:linear-gradient(180deg,#0b1020,#070b16); color:var(--text);}
    header{padding:18px 16px; border-bottom:1px solid rgba(255,255,255,.08); position:sticky; top:0; backdrop-filter: blur(8px); background:rgba(11,16,32,.7);}
    h1{margin:0;font-size:18px} .sub{color:var(--muted); font-size:13px; margin-top:4px}
    main{max-width:1100px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width:980px){ main{grid-template-columns: 420px 1fr;} }
    .card{background:rgba(18,26,51,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; box-shadow:0 10px 40px rgba(0,0,0,.25);}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select,button,textarea{
      width:100%; padding:10px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:#0b1228; color:var(--text); outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(130,170,255,.55)}
    .col{flex:1; min-width:140px}
    .btn{cursor:pointer; font-weight:700}
    .btn.primary{background:linear-gradient(90deg,#3b82f6,#22c55e); border:none}
    .btn.ghost{background:transparent}
    .btn.danger{background:rgba(255,92,122,.12); border:1px solid rgba(255,92,122,.35)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(11,18,40,.55); font-size:12px; color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media(min-width:980px){ .kpi{grid-template-columns:repeat(4,1fr);} }
    .kpi .card{padding:12px}
    .kpi .v{font-size:18px; font-weight:800; margin-top:6px}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px 8px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right}
    th{color:var(--muted); font-weight:700; background:rgba(11,18,40,.55)}
    tr:hover td{background:rgba(255,255,255,.03)}
    .small{font-size:12px; color:var(--muted)}
    .split{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .right{margin-inline-start:auto}
    .tag{padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10); color:var(--muted); font-size:11px}
    .tag.good{border-color:rgba(65,211,139,.35); color:rgba(65,211,139,.95)}
    .tag.bad{border-color:rgba(255,92,122,.35); color:rgba(255,92,122,.95)}
    .tag.warn{border-color:rgba(255,204,102,.35); color:rgba(255,204,102,.95)}
    .divider{height:1px; background:rgba(255,255,255,.08); margin:10px 0}
    .checkgrid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    @media(min-width:980px){ .checkgrid{grid-template-columns:1fr 1fr 1fr;} }
    .checkitem{display:flex; gap:8px; align-items:flex-start; padding:10px; border-radius:12px; background:rgba(11,18,40,.55); border:1px solid rgba(255,255,255,.08)}
    .checkitem input{width:auto; margin-top:2px}
    .hint{color:var(--muted); font-size:12px; line-height:1.5}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
  </style>
</head>
<body>
<header>
  <h1>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ â€” RR / HR + Checklist</h1>
  <div class="sub">1R = 1% Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ â€¢ RR Ø§Ù„Ø£Ø¯Ù†Ù‰ 1:2 â€¢ ØªÙ†ÙÙŠØ° 15m/5m Ø¨Ø¹Ø¯ Ù‚Ø±Ø§Ø± 4H ÙˆØªØ¶ÙŠÙŠÙ‚ 1H</div>
</header>

<main>
  <!-- LEFT: Strategy + Entry -->
  <section class="card">
    <div class="split">
      <div class="pill">ğŸ“Œ <b>Ù‚Ø§Ù†ÙˆÙ†Ùƒ</b> <span class="small">A+B+C + RRâ‰¥1:2 + Risk=1%</span></div>
      <button class="btn ghost right" id="resetAllBtn" title="Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="col">
        <label>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ($)</label>
        <input id="equity" type="number" min="1" step="0.01" value="100" />
      </div>
      <div class="col">
        <label>Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ù„ÙƒÙ„ ØµÙÙ‚Ø© (%)</label>
        <select id="riskPct">
          <option value="1" selected>1%</option>
          <option value="0.5">0.5%</option>
          <option value="2">2%</option>
        </select>
      </div>
      <div class="col">
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø®Ø³Ø§Ø±Ø© (%)</label>
        <select id="dailyLossLimitPct">
          <option value="2" selected>2%</option>
          <option value="3">3%</option>
          <option value="1">1%</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;font-size:14px">âœ… Checklist Ù‚Ø¨Ù„ Ø§Ù„ØµÙÙ‚Ø©</h3>
    <div class="checkgrid" id="checklist">
      <div class="checkitem"><input type="checkbox" id="chkA"><div><b>A Ø§Ù„Ø§ØªØ¬Ø§Ù‡ 4H ÙˆØ§Ø¶Ø­</b><div class="hint">ØµØ§Ø¹Ø¯=Ù„ÙˆÙ†Ø¬ ÙÙ‚Ø·ØŒ Ù‡Ø§Ø¨Ø·=Ø´ÙˆØ±Øª ÙÙ‚Ø·</div></div></div>
      <div class="checkitem"><input type="checkbox" id="chkB"><div><b>B Ø§Ù„Ù…ÙƒØ§Ù† 1H</b><div class="hint">Ø¹Ø±Ø¶/Ø·Ù„Ø¨ + (0.5â€“0.618) Ø¥Ù† Ø£Ù…ÙƒÙ†</div></div></div>
      <div class="checkitem"><input type="checkbox" id="chkC"><div><b>C Ø¥Ø´Ø§Ø±Ø© 15m/5m</b><div class="hint">Ø±ÙØ¶/Ø§Ø¨ØªÙ„Ø§Ø¹/ÙƒØ³Ø±+Ø±ÙŠØªØ³Øª/Ø¶Ø¹Ù Ø²Ø®Ù…</div></div></div>
      <div class="checkitem"><input type="checkbox" id="chkRR"><div><b>RR â‰¥ 1 : 2</b><div class="hint">Ø£Ù‚Ù„ Ù…Ù† Ù‡ÙŠÙƒ = Ù…Ø±ÙÙˆØ¶</div></div></div>
      <div class="checkitem"><input type="checkbox" id="chkRisk"><div><b>Risk = 1R ÙÙ‚Ø·</b><div class="hint">Ù„Ø§ ØªÙƒØ¨ÙŠØ± Ù…Ø®Ø§Ø·Ø±Ø©</div></div></div>
      <div class="checkitem"><input type="checkbox" id="chkMind"><div><b>Ù…Ø²Ø§Ø¬ÙŠ Ù‡Ø§Ø¯ÙŠ</b><div class="hint">Ù…Ø´ ØºØ¶Ø¨Ø§Ù†/Ù…Ø´ Ø§Ø³ØªØ¹Ø¬Ø§Ù„/Ù…Ø´ Ø§Ù†ØªÙ‚Ø§Ù…</div></div></div>
    </div>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;font-size:14px">â• Ø¥Ø¶Ø§ÙØ© ØµÙÙ‚Ø©</h3>

    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ø²ÙˆØ¬</label>
        <input id="symbol" placeholder="Ù…Ø«Ø§Ù„: XMRUSDT" value="XMRUSDT" />
      </div>
      <div class="col">
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="side">
          <option value="LONG" selected>LONG</option>
          <option value="SHORT">SHORT</option>
        </select>
      </div>
      <div class="col">
        <label>Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</label>
        <select id="tf">
          <option value="15m" selected>15m</option>
          <option value="5m">5m</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Entry</label>
        <input id="entry" type="number" step="0.0001" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„" />
      </div>
      <div class="col">
        <label>Stop</label>
        <input id="stop" type="number" step="0.0001" placeholder="Ø³ØªÙˆØ¨" />
      </div>
      <div class="col">
        <label>Take Profit</label>
        <input id="tp" type="number" step="0.0001" placeholder="Ù‡Ø¯Ù" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Ø³Ø¨Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ø®ØªØµØ±Ù‡Ø§)</label>
        <input id="reason" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø¨ 1H + ÙÙŠØ¨Ùˆ 0.618 + Ø§Ø¨ØªÙ„Ø§Ø¹ 15m" />
      </div>
      <div class="col">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµÙÙ‚Ø© (R)</label>
        <select id="resultR">
          <option value="">â€” Ø§Ø®ØªØ± â€”</option>
          <option value="-1">Ø®Ø³Ø§Ø±Ø© (-1R)</option>
          <option value="2">Ø±Ø¨Ø­ (2R)</option>
          <option value="2.5">Ø±Ø¨Ø­ (2.5R)</option>
          <option value="3">Ø±Ø¨Ø­ (3R)</option>
          <option value="0">ØªØ¹Ø§Ø¯Ù„ (0R)</option>
        </select>
      </div>
      <div class="col">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="date" type="date" />
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn primary" id="addTradeBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;font-size:14px">ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø© (Position Size)</h3>
    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© $ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
        <input id="riskUsd" class="mono" disabled />
      </div>
      <div class="col">
        <label>Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ø³ØªÙˆØ¨ (|Entry-Stop|)</label>
        <input id="stopDist" class="mono" disabled />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ© (Units) â‰ˆ Risk$ Ã· StopDist</label>
        <input id="positionUnits" class="mono" disabled />
      </div>
      <div class="col">
        <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¹Ù†Ø¯ 1R ($)</label>
        <input id="oneRUsd" class="mono" disabled />
      </div>
    </div>
    <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ©. ÙÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©/Ø§Ù„Ø±Ø§ÙØ¹Ø©ØŒ Ø§Ù„Ù‡Ø§Ù…Ø´ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ† â€œØ§Ù„Ø®Ø·Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠâ€ ÙŠØ¨Ù‚Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø³ØªÙˆØ¨.</div>
  </section>

  <!-- RIGHT: Stats + Table -->
  <section class="card">
    <div class="kpi">
      <div class="card">
        <div class="small">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª</div>
        <div class="v" id="kTrades">0</div>
      </div>
      <div class="card">
        <div class="small">HR (Ù†Ø³Ø¨Ø© Ù†Ø¬Ø§Ø­)</div>
        <div class="v" id="kHR">0%</div>
      </div>
      <div class="card">
        <div class="small">Ù…ØªÙˆØ³Ø· RR (Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬)</div>
        <div class="v" id="kAvgRR">â€”</div>
      </div>
      <div class="card">
        <div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ R</div>
        <div class="v" id="kTotalR">0R</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="split">
      <div class="row" style="flex:1">
        <div class="col" style="min-width:220px">
          <label>ÙÙ„ØªØ±Ø©: Ø§Ù„Ø²ÙˆØ¬</label>
          <input id="filterSymbol" placeholder="Ù…Ø«Ø§Ù„: XMRUSDT (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø¶ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬)" />
        </div>
        <div class="col" style="min-width:180px">
          <label>ÙÙ„ØªØ±Ø©: Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="filterMonth" type="month" />
        </div>
      </div>
      <div class="right split">
        <span class="tag warn" id="dailyGuard">Ø­Ø§Ø±Ø³ Ø§Ù„ÙŠÙˆÙ…: ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨</span>
        <button class="btn ghost" id="exportBtn">ØªØµØ¯ÙŠØ± CSV</button>
      </div>
    </div>

    <div class="divider"></div>

    <table>
      <thead>
        <tr>
          <th>ØªØ§Ø±ÙŠØ®</th>
          <th>Ø²ÙˆØ¬</th>
          <th>Ù†ÙˆØ¹</th>
          <th>TF</th>
          <th>Entry</th>
          <th>Stop</th>
          <th>TP</th>
          <th>RR</th>
          <th>Result (R)</th>
          <th>Result ($)</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="divider"></div>
    <div class="hint">
      <b>Ù‚Ø§Ù†ÙˆÙ† ØªÙˆÙ‚Ù Ø§Ù„ÙŠÙˆÙ…:</b> Ø¥Ø°Ø§ Ù…Ø¬Ù…ÙˆØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙŠÙˆÙ… â‰¤ -{Ø­Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ}% (Ø¨Ø§Ù„Ù€R)ØŒ ØªÙˆÙ‚Ù.  
      Ù…Ø«Ø§Ù„: Ù…Ø®Ø§Ø·Ø±Ø© 1% ÙˆØ­Ø¯ ÙŠÙˆÙ…ÙŠ 2% â†’ Ø¥Ø°Ø§ ÙˆØµÙ„Øª -2R Ø®Ù„Ø§Ù„ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ = ØªÙˆÙ‚Ù.
    </div>
  </section>
</main>

<script>
  // ===== Utilities =====
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=2) => (Number.isFinite(n) ? n.toFixed(d) : "â€”");
  const todayISO = () => new Date().toISOString().slice(0,10);

  // ===== State =====
  const LS_KEY = "trading_system_v1";
  let state = {
    equity: 100,
    riskPct: 1,
    dailyLossLimitPct: 2,
    trades: []
  };

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      try { state = JSON.parse(raw); } catch {}
    }
  }
  function save() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function calcRiskUsd() {
    const eq = Number(state.equity) || 0;
    const rp = Number(state.riskPct) || 0;
    return eq * (rp/100);
  }

  function calcRR(entry, stop, tp) {
    const e = Number(entry), s = Number(stop), t = Number(tp);
    if (![e,s,t].every(Number.isFinite) || e===s) return null;
    const risk = Math.abs(e - s);
    const reward = Math.abs(t - e);
    if (risk <= 0) return null;
    return reward / risk;
  }

  function updateCalculator() {
    const riskUsd = calcRiskUsd();
    const e = Number($("entry").value);
    const s = Number($("stop").value);
    const dist = (Number.isFinite(e) && Number.isFinite(s)) ? Math.abs(e-s) : NaN;
    const units = (Number.isFinite(dist) && dist>0) ? (riskUsd / dist) : NaN;

    $("riskUsd").value = fmt(riskUsd,2);
    $("stopDist").value = Number.isFinite(dist) ? fmt(dist,6) : "â€”";
    $("positionUnits").value = Number.isFinite(units) ? fmt(units,4) : "â€”";
    $("oneRUsd").value = fmt(riskUsd,2);
  }

  function checklistOk() {
    const req = ["chkA","chkB","chkC","chkRR","chkRisk","chkMind"];
    return req.every(id => $(id).checked);
  }

  function renderStats(filteredTrades) {
    const trades = filteredTrades;
    const n = trades.length;
    const wins = trades.filter(t => Number(t.resultR) > 0).length;
    const losses = trades.filter(t => Number(t.resultR) < 0).length;
    const hr = n ? (wins / n) * 100 : 0;

    const totalR = trades.reduce((a,t)=> a + (Number(t.resultR)||0), 0);
    const avgRR = (() => {
      const rrVals = trades.map(t => Number(t.rr)).filter(v => Number.isFinite(v) && v>0);
      if (!rrVals.length) return null;
      return rrVals.reduce((a,b)=>a+b,0)/rrVals.length;
    })();

    $("kTrades").textContent = n;
    $("kHR").textContent = `${fmt(hr,0)}%`;
    $("kTotalR").textContent = `${fmt(totalR,2)}R`;
    $("kAvgRR").textContent = avgRR ? `1:${fmt(avgRR,2)}` : "â€”";
  }

  function dailyGuardBadge() {
    // compute today's total R (all symbols)
    const d = todayISO();
    const todayTrades = state.trades.filter(t => t.date === d);
    const totalR = todayTrades.reduce((a,t)=>a + (Number(t.resultR)||0), 0);

    // daily loss limit in R = dailyLossLimitPct / riskPct
    const dailyRLimit = -(Number(state.dailyLossLimitPct) / Number(state.riskPct)); // negative
    const el = $("dailyGuard");
    if (!todayTrades.length) {
      el.textContent = "Ø­Ø§Ø±Ø³ Ø§Ù„ÙŠÙˆÙ…: Ù„Ø§ ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…";
      el.className = "tag warn";
      return;
    }
    if (totalR <= dailyRLimit) {
      el.textContent = `Ø­Ø§Ø±Ø³ Ø§Ù„ÙŠÙˆÙ…: ØªÙˆÙ‚Ù‘Ù (ÙˆØµÙ„Øª ${fmt(totalR,2)}R)`;
      el.className = "tag bad";
    } else {
      el.textContent = `Ø­Ø§Ø±Ø³ Ø§Ù„ÙŠÙˆÙ…: OK (Ø§Ù„ÙŠÙˆÙ… ${fmt(totalR,2)}R)`;
      el.className = "tag good";
    }
  }

  function getFilteredTrades() {
    const fs = $("filterSymbol").value.trim().toUpperCase();
    const fm = $("filterMonth").value; // YYYY-MM
    return state.trades.filter(t => {
      const okS = fs ? t.symbol.toUpperCase().includes(fs) : true;
      const okM = fm ? t.date.startsWith(fm) : true;
      return okS && okM;
    });
  }

  function renderTable() {
    const tbody = $("tbody");
    tbody.innerHTML = "";
    const riskUsd = calcRiskUsd();

    const trades = getFilteredTrades();
    trades
      .slice()
      .sort((a,b)=> (b.date+a.id).localeCompare(a.date+b.id))
      .forEach(t => {
        const tr = document.createElement("tr");
        const resR = Number(t.resultR)||0;
        const resUsd = resR * riskUsd;

        const tag = (resR>0) ? `<span class="tag good">Win</span>` : (resR<0 ? `<span class="tag bad">Loss</span>` : `<span class="tag warn">BE</span>`);
        tr.innerHTML = `
          <td>${t.date}</td>
          <td>${t.symbol}</td>
          <td>${t.side}</td>
          <td>${t.tf}</td>
          <td>${t.entry ?? ""}</td>
          <td>${t.stop ?? ""}</td>
          <td>${t.tp ?? ""}</td>
          <td>${t.rr ? ("1:"+fmt(t.rr,2)) : "â€”"}</td>
          <td>${tag} <span class="mono">${fmt(resR,2)}R</span></td>
          <td class="mono ${resUsd>=0?'good':'bad'}">${fmt(resUsd,2)}$</td>
          <td title="${(t.reason||"")}\n${(t.notes||"")}">${(t.reason||"").slice(0,36)}${(t.reason||"").length>36?"â€¦":""}</td>
          <td><button class="btn danger" data-del="${t.id}">Ø­Ø°Ù</button></td>
        `;
        tbody.appendChild(tr);
      });

    renderStats(trades);
    dailyGuardBadge();
  }

  function addTrade() {
    if (!checklistOk()) {
      alert("Ù„Ø§Ø²Ù… ØªÙƒÙ…Ù‘Ù„ Ø§Ù„Ù€ Checklist ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© ØµÙÙ‚Ø©.");
      return;
    }

    const symbol = $("symbol").value.trim() || "â€”";
    const side = $("side").value;
    const tf = $("tf").value;
    const entry = $("entry").value ? Number($("entry").value) : null;
    const stop = $("stop").value ? Number($("stop").value) : null;
    const tp = $("tp").value ? Number($("tp").value) : null;
    const reason = $("reason").value.trim();
    const notes = $("notes").value.trim();
    const date = $("date").value || todayISO();
    const resultR = $("resultR").value;

    if (resultR === "") {
      alert("Ø§Ø®ØªØ§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµÙÙ‚Ø© (R).");
      return;
    }

    const rr = (entry!=null && stop!=null && tp!=null) ? calcRR(entry, stop, tp) : null;

    // Enforce RR>=2 (strategy rule) when rr is available:
    if (rr != null && rr < 2) {
      alert("RR Ø£Ù‚Ù„ Ù…Ù† 1:2 â€” Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙÙ‚Ø© Ù…Ø±ÙÙˆØ¶Ø©.");
      return;
    }

    // build trade
    const t = {
      id: String(Date.now()),
      date, symbol, side, tf,
      entry, stop, tp,
      rr,
      resultR: Number(resultR),
      reason, notes
    };

    state.trades.push(t);
    save();
    renderTable();

    // optional clear some fields
    $("resultR").value = "";
    $("notes").value = "";
  }

  function exportCSV() {
    const trades = getFilteredTrades();
    const header = ["date","symbol","side","tf","entry","stop","tp","rr","resultR","reason","notes"];
    const rows = trades.map(t => header.map(k => {
      const v = (t[k] ?? "");
      const s = String(v).replace(/"/g,'""');
      return `"${s}"`;
    }).join(","));
    const csv = [header.join(","), ...rows].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "trading_journal.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function resetAll() {
    if (!confirm("Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
    localStorage.removeItem(LS_KEY);
    state = { equity: 100, riskPct: 1, dailyLossLimitPct: 2, trades: [] };
    initUI();
    save();
    renderTable();
  }

  function initUI() {
    $("equity").value = state.equity ?? 100;
    $("riskPct").value = String(state.riskPct ?? 1);
    $("dailyLossLimitPct").value = String(state.dailyLossLimitPct ?? 2);
    $("date").value = todayISO();
    updateCalculator();
  }

  // ===== Events =====
  function wire() {
    ["equity","riskPct","dailyLossLimitPct"].forEach(id => {
      $(id).addEventListener("input", () => {
        state.equity = Number($("equity").value) || 0;
        state.riskPct = Number($("riskPct").value) || 1;
        state.dailyLossLimitPct = Number($("dailyLossLimitPct").value) || 2;
        save();
        updateCalculator();
        renderTable();
      });
      $(id).addEventListener("change", () => {
        state.equity = Number($("equity").value) || 0;
        state.riskPct = Number($("riskPct").value) || 1;
        state.dailyLossLimitPct = Number($("dailyLossLimitPct").value) || 2;
        save();
        updateCalculator();
        renderTable();
      });
    });

    ["entry","stop","tp"].forEach(id => $(id).addEventListener("input", updateCalculator));

    $("addTradeBtn").addEventListener("click", addTrade);
    $("exportBtn").addEventListener("click", exportCSV);
    $("resetAllBtn").addEventListener("click", resetAll);

    $("filterSymbol").addEventListener("input", renderTable);
    $("filterMonth").addEventListener("change", renderTable);

    $("tbody").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const id = btn.getAttribute("data-del");
      state.trades = state.trades.filter(t => t.id !== id);
      save();
      renderTable();
    });
  }

  // ===== Boot =====
  load();
  initUI();
  wire();
  renderTable();
</script>
</body>
</html>
